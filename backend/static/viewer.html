<!-- backend/static/viewer.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nexus Stream Viewer</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 12px; background:#0f1720; color:#e6eef8; }
    #video { width:100%; max-width:900px; border:1px solid #223; background:#000; display:block; margin-bottom:8px; }
    #log { height:180px; overflow:auto; background:#071024; padding:8px; border-radius:6px; border:1px solid #123; color:#9fd3ff; }
    #status { margin-bottom:6px; }
    .signal { color: #ffff7f; font-weight:700; }
  </style>
</head>
<body>
  <h2>Nexus Stream Viewer</h2>
  <div id="status">Status: <span id="st">desconectado</span></div>
  <img id="video" alt="Stream will appear here" />
  <div>
    <button id="clear">Limpar log</button>
  </div>
  <h4>Log</h4>
  <div id="log"></div>

<script>
const logEl = document.getElementById('log');
const stEl = document.getElementById('st');
const imgEl = document.getElementById('video');
let ws;

function log(msg){
  const line = document.createElement('div');
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logEl.prepend(line);
}

function connect(){
  const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/stream';
  ws = new WebSocket(url);
  ws.onopen = ()=>{ stEl.textContent = 'conectado'; log('WS conectado'); };
  ws.onmessage = (ev)=>{
    try{
      const data = JSON.parse(ev.data);
      if(data.type === 'frame' && data.b64){
        imgEl.src = 'data:image/png;base64,' + data.b64;
      } else if(data.type === 'ack') {
        log(`ACK size=${data.size} conf=${data.confidence}`);
      } else if(data.type === 'signal'){
        log('SIGNAL: ' + JSON.stringify(data));
        const s = document.createElement('div');
        s.className = 'signal';
        s.textContent = `ðŸ”” SIGNAL: ${data.pair} conf=${data.confidence}`;
        logEl.prepend(s);
      } else {
        log('MSG: ' + JSON.stringify(data));
      }
    }catch(e){
      log('msg parse error');
    }
  };
  ws.onclose = ()=>{ stEl.textContent = 'desconectado'; log('WS fechado'); setTimeout(connect,2000); };
  ws.onerror = (e)=>{ log('WS error'); console.error(e); ws.close(); };
}

document.getElementById('clear').onclick = ()=>{ logEl.innerHTML = ''; }

connect();
</script>
</body>
</html>
