<!-- backend/static/viewer.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nexus Viewer</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin:0; font-family:system-ui,Arial; background:#0b1220; color:#fff; }
    #chart { width:100%; height:48vh; }
    #imgPreview { width:100%; height:40vh; object-fit:contain; background:#111; display:block; }
    .overlay { position:fixed; top:10px; right:10px; z-index:9999; background:rgba(0,0,0,0.5); padding:8px; border-radius:8px; }
    .signal { padding:6px 8px; border-radius:6px; margin-top:6px; display:block;}
  </style>
</head>
<body>
  <div id="chart"></div>
  <img id="imgPreview" alt="stream frame"/>
  <div class="overlay">
    <div id="conn">Conexão: ❌</div>
    <div id="lastTick">Último tick: —</div>
    <div id="signals"></div>
    <div><a href="/history" target="_blank">Histórico</a></div>
  </div>

<script>
  const WS = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/viewer';
  const ws = new WebSocket(WS);
  const chart = LightweightCharts.createChart(document.getElementById('chart'), { layout: { backgroundColor: '#0b1220', textColor: '#ffffff' }, timeScale: { timeVisible: true, secondsVisible: false } });
  const candleSeries = chart.addCandlestickSeries();
  let history = [];
  ws.onopen = ()=> document.getElementById('conn').textContent = 'Conexão: ✅';
  ws.onclose = ()=> document.getElementById('conn').textContent = 'Conexão: ❌';
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'frame') {
        document.getElementById('imgPreview').src = 'data:image/jpeg;base64,' + msg.data;
      } else if (msg.type === 'tick') {
        const t = msg.tick;
        const time = (new Date(t.timestamp)).toISOString().replace('Z','');
        candleSeries.update({ time: time, open: t.open, high: t.high, low: t.low, close: t.close });
        document.getElementById('lastTick').textContent = `Último tick: ${t.pair} ${t.close} ${t.timestamp}`;
      } else if (msg.type === 'signal') {
        const s = msg.signal;
        const el = document.createElement('div');
        el.className = 'signal';
        el.style.background = s.side === 'CALL' ? '#0b662d' : '#6a0019';
        el.textContent = `${s.pair} • ${s.side} • ${Math.round(s.confidence*100)}% • ${s.reason}`;
        document.getElementById('signals').prepend(el);
      }
    } catch(e){ console.error(e); }
  };
</script>
</body>
</html>
