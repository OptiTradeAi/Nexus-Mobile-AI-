<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nexus Viewer - Real-Time Chart</title>
  <style>
    body{margin:0;background:#0a0a0a;color:#fff;font-family:Arial,Helvetica,sans-serif}
    header{padding:10px;background:#111;border-bottom:1px solid #222}
    .container{padding:10px;max-width:900px;margin:0 auto}
    #live{width:100%;height:auto;background:#000;display:block;border:1px solid #222;margin-bottom:10px}
    .panel{background:#111;padding:8px;border-radius:6px;margin-bottom:8px;border:1px solid #222}
    pre{white-space:pre-wrap;word-break:break-word;color:#9cf}
    .small{font-size:12px;color:#bbb}
  </style>
</head>
<body>
  <header><strong>Nexus Viewer — Real-Time Chart</strong></header>
  <div class="container">
    <img id="live" src="" alt="frames" />
    <div class="panel">
      <div class="small">Conexão: <span id="status">—</span></div>
      <div class="small">Pair: <span id="pair">—</span></div>
      <div class="small">Último RID: <span id="rid">—</span></div>
    </div>

    <div class="panel">
      <h4 style="margin:0 0 6px 0">Pusher / Eventos recebidos</h4>
      <div id="pusherLog"></div>
    </div>

    <div class="panel">
      <h4 style="margin:0 0 6px 0">OHLC / Dados</h4>
      <div id="ohlcLog"></div>
    </div>

    <div class="panel">
      <h4 style="margin:0 0 6px 0">Sinais</h4>
      <div id="signals"></div>
    </div>
  </div>

<script>
const WS_TOKEN = 'd33144d6cb84fe05bf38bb9f22591683';
const WS_URL = `wss://${location.host.replace(/^https?:\/\//,'').split(':')[0]}/ws?token=${WS_TOKEN}`;
// If your domain is different, use full URL:
const FULL_WS = `wss://nexus-mobile-ai.onrender.com/ws?token=${WS_TOKEN}`;

const wsUrl = FULL_WS;
let ws = null;
const statusEl = document.getElementById('status');
const pairEl = document.getElementById('pair');
const ridEl = document.getElementById('rid');
const live = document.getElementById('live');
const pusherLog = document.getElementById('pusherLog');
const ohlcLog = document.getElementById('ohlcLog');
const signalsDiv = document.getElementById('signals');
let lastBlobUrl = null;

function connect(){
  ws = new WebSocket(wsUrl);
  ws.binaryType = 'arraybuffer';
  ws.onopen = ()=>{ statusEl.textContent='Conectado'; statusEl.style.color='lightgreen'; };
  ws.onmessage = (ev)=>{
    if (ev.data instanceof ArrayBuffer) {
      const blob = new Blob([ev.data], {type:'image/jpeg'});
      if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
      lastBlobUrl = URL.createObjectURL(blob);
      live.src = lastBlobUrl;
      return;
    }
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'meta') {
        pairEl.textContent = msg.pair || pairEl.textContent;
        ridEl.textContent = msg.rid || ridEl.textContent;
      } else if (msg.type === 'pusher_event') {
        const el = document.createElement('pre'); el.textContent = (new Date(msg.client_ts||Date.now())).toLocaleTimeString() + ' — ' + JSON.stringify(msg.payload_raw||msg, null, 0);
        pusherLog.insertBefore(el, pusherLog.firstChild);
      } else if (msg.type === 'ohlc_m5' || (msg.data && msg.data.values)) {
        const el = document.createElement('pre'); el.textContent = JSON.stringify(msg, null, 2);
        ohlcLog.insertBefore(el, ohlcLog.firstChild);
      } else if (msg.type === 'signal' || msg.signal) {
        const sig = msg.signal || msg;
        const card = document.createElement('div'); card.style.marginBottom='6px'; card.style.border='1px solid #333'; card.style.padding='6px';
        card.innerHTML = `<strong>${sig.action||sig.type}</strong> ${sig.pair||''} · ${sig.timeframe||''} <div class="small">${sig.reason||''}</div>`;
        if (sig.audio_url) {
          const b = document.createElement('button'); b.textContent='Ouvir'; b.onclick=()=>{ new Audio(sig.audio_url).play(); };
          card.appendChild(b);
        }
        signalsDiv.insertBefore(card, signalsDiv.firstChild);
      } else {
        const p = document.createElement('pre'); p.textContent = JSON.stringify(msg, null, 0);
        pusherLog.insertBefore(p, pusherLog.firstChild);
      }
    } catch(e){
      console.log('parse err', e);
    }
  };
  ws.onclose = ()=>{ statusEl.textContent='Desconectado'; statusEl.style.color='orange'; setTimeout(connect,2000); };
  ws.onerror = (e)=>{ statusEl.textContent='Erro'; statusEl.style.color='red'; console.error(e); };
}
connect();
</script>
</body>
</html>
