<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Nexus Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#e6eef8;display:flex;flex-direction:column;height:100vh}
    header{padding:12px;background:#071029;display:flex;align-items:center;gap:12px}
    #status{font-weight:700}
    #container{flex:1; display:flex; gap:12px; padding:12px}
    #videoBox{flex:2; background:#071029; border-radius:8px; padding:8px; display:flex; align-items:center; justify-content:center; position:relative}
    img#streamImg{max-width:100%; max-height:100%; border-radius:6px; box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    #pairLabel{position:absolute; left:12px; top:12px; background:rgba(2,6,23,0.8); padding:6px 10px; border-radius:6px; font-weight:700; color:#a5f3fc}
    #side{width:360px; background:#071029; border-radius:8px; padding:12px; overflow:auto}
    .signal{padding:8px;border-radius:6px;margin-bottom:8px;background:#042435}
    .signal.win{border-left:4px solid #10b981}
    .signal.loss{border-left:4px solid #ef4444}
    #log{font-size:13px; color:#cbd5e1}
    #small{font-size:12px;color:#9aa6b2}
  </style>
</head>
<body>
  <header>
    <div id="status">Conectando ao servidor...</div>
    <div style="margin-left:auto">Nexus Viewer</div>
  </header>
  <div id="container">
    <div id="videoBox">
      <div id="pairLabel">‚Äî</div>
      <img id="streamImg" src="" alt="Awaiting stream...">
    </div>
    <aside id="side">
      <h3>Sinais (>= 0.8)</h3>
      <div id="signals"></div>
      <h3>Log</h3>
      <div id="log"></div>
      <div id="small" style="margin-top:8px">Observa√ß√£o: frames via POST/WS ; refresh autom√°tico ao reconectar.</div>
    </aside>
  </div>

<script>
(function(){
  const statusEl = document.getElementById('status');
  const img = document.getElementById('streamImg');
  const signals = document.getElementById('signals');
  const log = document.getElementById('log');
  const pairLabel = document.getElementById('pairLabel');

  const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/viewer';
  let ws = null;

  function addLog(t){ const d = document.createElement('div'); d.textContent = '['+new Date().toLocaleTimeString()+'] '+t; log.prepend(d); }
  function addSignal(s){
    const el = document.createElement('div');
    el.className = 'signal';
    el.textContent = `[${s.timestamp}] ${s.pair} ‚Äî ${s.signal} ‚Äî Confian√ßa: ${(s.confidence*100).toFixed(1)}%`;
    signals.prepend(el);
  }

  function setPairLabel(p){
    pairLabel.textContent = p || '‚Äî';
  }

  function connect(){
    ws = new WebSocket(WS_URL);
    ws.onopen = ()=> {
      statusEl.textContent = 'üü¢ Conectado';
      statusEl.style.color = '#4ade80';
      addLog('Viewer conectado');
    };
    ws.onclose = ()=> {
      statusEl.textContent = 'üî¥ Desconectado - reconectando...';
      statusEl.style.color = '#f87171';
      addLog('Viewer desconectado');
      setTimeout(connect, 3000);
    };
    ws.onerror = (e)=> {
      addLog('Erro WS: ' + JSON.stringify(e));
    };
    ws.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);
        if(data.type === 'frame'){
          // data.data is base64 (no prefix)
          img.src = 'data:image/jpeg;base64,' + data.data;
          setPairLabel(data.pair || 'OTC');
          addLog('Frame recebido: ' + (data.pair || 'OTC'));
        } else if(data.type === 'signal'){
          addSignal(data.data);
          addLog('Signal: ' + JSON.stringify(data.data));
        } else if(data.type === 'history'){
          addLog('Hist√≥rico recebido (' + (data.data||[]).length +')');
        }
      } catch(e) {
        addLog('Erro parse msg: ' + e);
      }
    };
  }

  connect();
})();
</script>
</body>
</html>
