<!-- backend/static/viewer.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nexus Mobile AI - Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0f1724; color:#e6eef8; margin:0; padding:12px; }
    .container { display:flex; gap:12px; max-width:1200px; margin:12px auto; }
    .left { flex: 2; background:#081028; padding:12px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6);}
    .right { flex: 1; background:#071024; padding:12px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6);}
    #streamImg { width:100%; border-radius:8px; background:#001; min-height:280px; display:block; object-fit:contain; }
    h2 { margin:6px 0; font-size:16px; }
    .signal { padding:10px; border-radius:8px; margin-bottom:8px; background: linear-gradient(90deg,#08334d,#004b6b); }
    .history-row { display:flex; justify-content:space-between; padding:8px; border-bottom:1px dashed rgba(255,255,255,0.03); }
    .controls { display:flex; gap:8px; margin-bottom:8px; }
    .btn { background:#076; color:white; padding:8px 10px; border-radius:8px; cursor:pointer; border:none; }
    .small { font-size:12px; color:#9fb7d3; }
  </style>
</head>
<body>
  <div style="max-width:1200px;margin:0 auto;">
    <h1 style="font-size:20px">Nexus Mobile AI — Stream Viewer</h1>
    <div style="display:flex;gap:12px;align-items:center;">
      <div class="controls">
        <button id="btnRegisterViewer" class="btn">Register Viewer</button>
        <button id="btnClearHistory" class="btn" style="background:#ff5c5c">Clear History</button>
        <input id="backendUrl" style="padding:8px;border-radius:8px;border:none" value="wss://nexus-mobile-ai.onrender.com/ws/stream">
      </div>
      <div class="small">Status: <span id="status">disconnected</span></div>
    </div>
    <div class="container">
      <div class="left">
        <h2>Espelhamento (Imagem)</h2>
        <img id="streamImg" src="" alt="stream frame will appear here" />
        <div id="signalBox"></div>
      </div>
      <div class="right">
        <h2>History</h2>
        <div id="history"></div>
        <h2>Debug / Info</h2>
        <pre id="debug" style="white-space:pre-wrap; font-size:12px; color:#9fb7d3;"></pre>
      </div>
    </div>
  </div>

<script>
let ws = null;
const statusEl = document.getElementById('status');
const imgEl = document.getElementById('streamImg');
const debugEl = document.getElementById('debug');
const historyEl = document.getElementById('history');
const signalBox = document.getElementById('signalBox');

document.getElementById('btnRegisterViewer').onclick = () => {
  const url = document.getElementById('backendUrl').value.trim();
  if (!url) return alert('set backend wss url');
  if (ws) ws.close();
  connect(url);
};

document.getElementById('btnClearHistory').onclick = () => {
  historyEl.innerHTML = '';
  fetch('/history').then(r=>r.json()).then(j=>{ debug('history cleared (local view)');});
};

function debug(msg){ debugEl.innerText = (new Date()).toLocaleTimeString() + " - " + msg + "\n" + debugEl.innerText; }

function connect(url) {
  try {
    ws = new WebSocket(url);
    ws.onopen = () => {
      statusEl.innerText = 'connected';
      debug('ws open');
      // identify as viewer
      ws.send(JSON.stringify({role:'viewer'}));
    };
    ws.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.type === 'frame' && data.data) {
          imgEl.src = data.data;
        } else if (data.type === 'signal') {
          debug('signal: ' + JSON.stringify(data));
          showSignal(data);
          // append to history
          appendHistory({id:data.id, pair:data.pair, confidence:data.confidence, timestamp:data.timestamp, result:'PENDING'});
        } else if (data.type === 'history_update') {
          debug('history update: ' + JSON.stringify(data));
          updateHistoryRow(data.id, data.result);
        } else if (data.type === 'info' || data.type === 'ack') {
          debug('info: ' + JSON.stringify(data));
        }
      } catch (e) {
        debug('non-json message: '+ ev.data);
      }
    };
    ws.onclose = () => { statusEl.innerText = 'closed'; debug('ws closed'); };
    ws.onerror = (e) => { statusEl.innerText = 'error'; debug('ws error'); console.error(e); };
  } catch (e) {
    debug('connect error: '+e);
  }
}

function showSignal(s) {
  const d = document.createElement('div');
  d.className = 'signal';
  d.innerHTML = `<strong>Signal:</strong> ${s.pair} — ${Math.round(s.confidence*100)}% <div class="small">${s.timeframe} — ${new Date(s.timestamp).toLocaleTimeString()}</div>`;
  signalBox.prepend(d);
  setTimeout(()=> d.remove(), 15000);
}

function appendHistory(h) {
  const row = document.createElement('div');
  row.className='history-row';
  row.id = 'h_'+h.id;
  row.innerHTML = `<div>${h.pair} <div class="small">${new Date(h.timestamp).toLocaleTimeString()}</div></div><div>${Math.round(h.confidence*100)}% <div class="small" id="res_${h.id}">${h.result}</div></div>`;
  historyEl.prepend(row);
}

function updateHistoryRow(id, result) {
  const el = document.getElementById('res_'+id);
  if (el) el.innerText = result;
}
</script>
</body>
</html>
